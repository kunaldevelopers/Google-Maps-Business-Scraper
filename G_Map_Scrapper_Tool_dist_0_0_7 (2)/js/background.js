try{importScripts("consts.js")}catch(e){console.error(e)}var version=chrome.runtime.getManifest().version,myAppObj={search_change:!1,onExtMessage:function(e,r,a){switch((myAppObj.message=e).command){case"console_logs_myApp":console_logs_myApp(e.title,e.msg);break;case"stopAutoBotProcess":myAppObj.stopAutoBotProcess(e.reason);break;case"viewAutoBotProcess":myAppObj.viewAutoBotProcess(e.data,r,a);break;case"startSearchProcess":myAppObj.startSearchProcess(e.data.Keywords_input,r,a);break;case"productTrialStarted":myAppObj.productTrialStarted(e.data,r,a);break;case"saveUserToServer":myAppObj.saveUserToServer(e.data,r,a);break;case"getEmailFromWebsite":myAppObj.getEmailFromWebsite(e.data,r,a);break;case"downloadCSV":myAppObj.downloadCSV(e.data,e.keyword);break;case"checkSearchStatus":chrome.storage.local.get(e=>{var t=!1;r&&r.tab&&r.tab.id&&parseInt(r.tab.id)==parseInt(e.active_search_tab_id)&&(t=!0),a({is_search:t})});break;case"startAutoBotProcess":myAppObj.create_notifications({title:"Business Scrapper Tool",msg:"Business Scrapper Tool proccess has been started"});break;case"set_delay_in_bg":setTimeout(function(){a()},e.timeout)}return!0},load:function(){myAppObj.initStorage()},initStorage:function(e){},create_notifications:function(e){chrome.notifications.create({type:"basic",iconUrl:chrome.runtime.getURL("images/default_icon_16.png"),title:e.title,message:e.msg},function(){chrome.runtime.lastError&&console.warn("Whoops.. "+chrome.runtime.lastError.message)})},startSearchProcess:function(e,t,r){chrome.storage.local.get(t=>{t.active_search_tab_id=0,t.current_processed_count=0,t.scrape_status="Finished",t.scrapped_items_arr=[],t.last_item_index=0,t.Keywords_input=e,chrome.storage.local.set({active_search_tab_id:t.active_search_tab_id,current_processed_count:t.current_processed_count,scrape_status:t.scrape_status,scrapped_items_arr:t.scrapped_items_arr,last_item_index:t.last_item_index,Keywords_input:t.Keywords_input});chrome.windows.getCurrent(function(e){chrome.windows.create({url:"https://www.google.com/maps/search/",width:600,height:600,type:"popup",focused:!0},async function(e){var e=e.tabs[0].id,e=(t.scrape_status="Inprogress",t.current_processed_count=0,t.active_search_tab_id=e,chrome.storage.local.set({active_search_tab_id:t.active_search_tab_id,current_processed_count:t.current_processed_count,scrape_status:t.scrape_status}),sendMessage("",{command:"updateScrapeState"},function(e){}),await myAppObj.checkXClientAndServerIdToServer(),await myAppObj.saveUserActivityToDB("",""));e&&e.insert_id&&(e=e.insert_id,chrome.storage.local.set({edit_id:e}))})})})},productTrialStarted:function(e){chrome.storage.local.get(async e=>{null!=e.product_trial_started&&0!=e.product_trial_started||(chrome.storage.local.set({product_trial_started:1}),myAppObj.saveXClientIdToServer())})},productLaunched:function(e){chrome.storage.local.get(async e=>{null!=e.product_launched&&0!=e.product_launched||(chrome.storage.local.set({product_launched:1}),myAppObj.saveXClientIdToServer())})},stopAutoBotProcess:function(c){chrome.storage.local.get(async e=>{for(var t=e.scrape_keywords_arr,r=[],a=0;a<t.length;a++)for(var s=t[a].result_items_arr||[],o=0;o<s.length;o++)r.push(s[o]);0<r.length?myAppObj.downloadCSV(r,e.scrape_keywords_file_name):myAppObj.create_notifications({title:"Business Scrapper Tool",msg:"No data found! Business Scrapper Tool process has been stopped."}),"next_profile_not_found"==c?myAppObj.create_notifications({title:"Business Scrapper Tool",msg:"Successfully Data scrapped and downloading CSV file has been started."}):"trial_version_expire"==c?myAppObj.create_notifications({title:"Business Scrapper Tool",msg:'Business Scrapper Tool process has been stopped!! because the "Trial Version" Only Scrap Up to 10 Data per Query means after some time if they try with other keyword then allow to scrap another 10 data. After 10 Data it will stop automatically.'}):"register_required"==c?myAppObj.create_notifications({title:"Business Scrapper Tool",msg:"Business Scrapper Tool process has been stopped and downloading CSV file has been started. You need to register for more scrape data."}):"user_not_approved"==c?myAppObj.create_notifications({title:"Business Scrapper Tool",msg:"Business Scrapper Tool process has been stopped and downloading CSV file has been started. You are not registered or your account is not approved for more scrape data."}):"manual_stop"==c&&myAppObj.create_notifications({title:"Business Scrapper Tool",msg:"Business Scrapper Tool process has been stopped and downloading CSV file has been started."}),sendMessage(e.active_search_tab_id,{command:"removeBlocker"},function(e){}),e.scrape_status="Finished",e.active_search_tab_id=0,chrome.storage.local.set({active_search_tab_id:e.active_search_tab_id,scrape_status:e.scrape_status}),sendMessage("",{command:"updateScrapeState"},function(e){});let n="";null!=e.edit_id&&(n=e.edit_id),await myAppObj.checkXClientAndServerIdToServer(),await myAppObj.saveUserActivityToDB(c,n)})},saveDataToServer:function(a){chrome.storage.local.get(e=>{var t=JSON.stringify(a),r=(t=(t=t.replace(/\\n/g,"\\n").replace(/\\'/g,"\\'").replace(/\\"/g,'\\"').replace(/\\&/g,"\\&").replace(/\\r/g,"\\r").replace(/\\t/g,"\\t").replace(/\\b/g,"\\b").replace(/\\f/g,"\\f")).replace(/[\u0000-\u0019]+/g,""),new URLSearchParams),t=(r.append("items_arr",t),r.append("user_email",e.username),e.saved_api_base_url||consts.base_api_url);fetch(t+consts.save_api_url,{method:"POST",body:r}).then(e=>e.text()).then(e=>console.log(e)).catch(e=>console.log(e))})},saveUserToServer:function(e,t,r){var a=new Headers,s=(a.append("Content-Type","application/x-www-form-urlencoded"),new URLSearchParams);s.append("email",e.user_email),s.append("product_id","1"),s.append("subscription_key",e.key),fetch(consts.base_api_url+consts.save_user_api_url,{method:"POST",headers:a,body:s,redirect:"follow"}).then(e=>e.json()).then(e=>r(e)).catch(e=>console.log("error",e))},saveXClientIdToServer:function(){chrome.storage.local.get(async e=>{e=e.X_Client_Id;null!=e?myAppObj.saveInstallToDB(e):await myAppObj.checkXClientAndServerIdToServer()})},checkXClientAndServerIdToServer:function(){return new Promise(async function(e,t){var r=await chrome.storage.local.get(),a=r.X_Client_Id;(null==a||null==r.server_user_id)&&(a=generateUUID(),r=await myAppObj.saveInstallToDB(a))&&1==r.success&&(chrome.storage.local.set({saveUserInstall:!0}),""!=r.server_user_id)&&null!=r.server_user_id&&(chrome.storage.local.set({server_user_id:r.server_user_id}),chrome.storage.local.set({X_Client_Id:a})),e()})},saveInstallToServer:async function(){var e=generateUUID(),t=await myAppObj.saveInstallToDB(e);t&&1==t.success&&(chrome.storage.local.set({saveUserInstall:!0}),""!=t.server_user_id)&&null!=t.server_user_id&&(chrome.storage.local.set({server_user_id:t.server_user_id}),chrome.storage.local.set({X_Client_Id:e}))},saveInstallToDB:function(s){return new Promise(async function(t,e){var r=await chrome.storage.local.get(),a=new Headers;a.append("X-Client-Id",s),a.append("x-product-id","1"),a.append("x-product-version",version),a.append("x-csrf-token",r.token_id||""),a.append("x-product-launched",r.product_launched||0),a.append("x-product-trial-started",r.product_trial_started||0),a.append("Content-Type","application/x-www-form-urlencoded"),fetch(consts.base_api_url+consts.save_install_api_url,{method:"POST",headers:a,redirect:"follow"}).then(e=>e.json()).then(e=>t(e)).catch(e=>t({}))})},saveUserActivityToDB:function(o,n){return new Promise(async function(t,e){var r,a,s=await chrome.storage.local.get();null!=s.X_Client_Id&&null!=s.server_user_id&&((r=new Headers).append("X-Client-Id",s.X_Client_Id),r.append("X-Server-Id",s.server_user_id),r.append("x-Product-id","1"),r.append("x-Product-Version",version),r.append("x-csrf-token",s.token_id||""),r.append("Content-Type","application/x-www-form-urlencoded"),(a=new URLSearchParams).append("scrape_status",s.scrape_status),a.append("current_processed_count",s.current_processed_count),a.append("total_scrapped_count",s.total_scrapped_count),a.append("scrape_limit",s.scrape_limit),a.append("scrape_limit_type",s.scrape_limit_type),a.append("scrape_type",s.scrape_type),a.append("search_query",s.Keywords_input+" ("+s.scrape_keywords_arr.length+")"),a.append("stop_reason",o),a.append("edit_id",n),fetch(consts.base_api_url+consts.save_activity_api_url,{method:"POST",body:a,headers:r,redirect:"follow"}).then(e=>e.json()).then(e=>t(e)).catch(e=>t({})))})},viewAutoBotProcess:function(e,t,r){PopupCenter(chrome.runtime.getURL("html/index.html"),"Business Scrapper Tool",1050,650)},getEmailFromWebsite:function(e,t,r){e=e.s_obj;fetch("https://www.google.com/search?q=%22email%22+site+%3A+"+e.website+"&&sourceid=chrome&ie=UTF-8",{method:"GET"}).then(e=>e.text()).then(e=>r(e)).catch(e=>r(e))},downloadCSV:function(a,s){chrome.storage.local.get(e=>{var t=new Date,t=t.getDate()+"-"+(t.getMonth()+1)+" "+t.getFullYear(),r="items_data_"+t,e=(null!=s&&""!=s||(s=e.scrape_keywords_file_name),e.scrape_keywords_arr);null!=s&&""!=s||1==e.length&&(s=e[0].keyword),""!=(s=s.replace(/.txt/gi,""))&&s&&(r=s+"_"+t),myAppObj.V2JSONToCSVConvertor(a,r,!0)})},V2JSONToCSVConvertor:function(e,t,r){var a="object"!=typeof e?JSON.parse(e):e,s="";if(r){var o="";for(c in a[0])o+=myAppObj.getKeyFromMap(c)+",";s+=(o=o.slice(0,-1))+"\r\n"}for(var n=0;n<a.length;n++){var c,o="";for(c in a[n]){a[n][c];var i=void 0===a[n][c]?"":(i=(a[n][c]+"").toString()).replace(/["]/gi,"'");o+='"'+i+'",'}o.slice(0,o.length-1),s+=o+"\r\n"}""==s?alert("Invalid data"):(e="",e+=t.replace(/ /g,"_"),r="data:text/csv;charset=utf-8,"+escape(s),chrome.downloads.download({url:r,filename:"G_Map_Scrapper_Tool/"+e+".csv"}))},checkAuthStatus:function(){myAppObj.authUserToServer({},"sender",function(e){e&&1==e.success&&0==e.data&&chrome.storage.local.set({userFreeTrialStarted:!0})})},authUserToServer:function(e,t,a){chrome.storage.local.get(e=>{var t=new Headers,r=(t.append("x-key",e.key),t.append("x-csrf-token",e.token_id),t.append("x-product-id","1"),t.append("Content-Type","application/x-www-form-urlencoded"),new URLSearchParams);r.append("email",e.authName),fetch(consts.v2_base_api_url+consts.auth_user_api_url,{method:"POST",headers:t,body:r,redirect:"follow"}).then(e=>e.json()).then(e=>a(e)).catch(e=>console.log("error",e))})},getKeyFromMap:function(e){return{business_name:"Name",full_dddress:"Address",street_address:"Area",city:"City",state:"State",zip:"Zip",plus_code:"Plus Code",category:"Category",phone_number:"Phone Number",is_claimed:"Is Claimed",website:"Website",email:"Email",rating_score:"Rating",reviews_count:"Reviews",number_of_photos:"Number of photos",open_hours:"hours of operations",review_summary:"Review Summary",link:"Link"}[e]||e},getParameterByName:function(e,t){t=t||window.location.href,e=e.replace(/[\[\]]/g,"\\$&");e=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return e?e[2]?decodeURIComponent(e[2].replace(/\+/g," ")):"":null},updateQueryStringParameter:function(e,t,r){var a=new RegExp("([?&])"+t+"=.*?(&|$)","i"),s=-1!==e.indexOf("?")?"&":"?";return e.match(a)?e.replace(a,"$1"+t+"="+r+"$2"):e+s+t+"="+r}};function sendMessage(e,t){e?chrome.tabs.sendMessage(e,t):chrome.runtime.sendMessage(t)}chrome.runtime.onMessage.addListener(myAppObj.onExtMessage),myAppObj.load();var console_logs_myApp=function(e,t){console.log("%c "+e,"font-weight: bold"),"object"==typeof t?console.log("%c "+JSON.stringify(t),"color:#ce3e3e"):console.log("%c "+t,"color:#ce3e3e")};function generateUUID(){var r=(new Date).getTime(),a=performance&&performance.now&&1e3*performance.now()||0;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random();return 0<r?(t=(r+t)%16|0,r=Math.floor(r/16)):(t=(a+t)%16|0,a=Math.floor(a/16)),("x"===e?t:3&t|8).toString(16)})}function PopupCenter(a,e,s,o){chrome.tabs.query({},function(e){var t="";if(e&&0<e.length)for(var r=0;r<e.length;r++)if(e[r].url&&e[r].url==a){t=e[r].id;break}""!=t&&parseInt(t)?chrome.tabs.get(parseInt(t),e=>{chrome.windows.update(e.windowId,{focused:!0},function(){}),chrome.tabs.update(parseInt(t),{active:!0},function(){})}):chrome.windows.getCurrent(function(e){var t=220+e.left;chrome.windows.create({url:a,width:s,height:o,top:Math.round(110+e.top),left:Math.round(t),type:"popup"})})})}chrome.tabs.onUpdated.addListener(function(e,t,r){"complete"==t.status&&"complete"==r.status&&r.url}),chrome.tabs.onRemoved.addListener(function(t,e){chrome.storage.local.get(e=>{e.active_search_tab_id==t&&(myAppObj.stopAutoBotProcess("manual_stop"),sendMessage("",{command:"updateScrapeState"},function(e){}))})}),chrome.action.onClicked.addListener(function(e){chrome.storage.local.get(e=>{PopupCenter(1==e.authUser&&0==e.userFreeTrialStarted?chrome.runtime.getURL("html/index.html"):chrome.runtime.getURL("html/free-version.html"),"Business Scrapper Tool",1050,650),myAppObj.productLaunched()})}),setInterval(function(){myAppObj.checkAuthStatus()},864e5),chrome.runtime.onInstalled.addListener(function(e){"install"==e.reason?(chrome.storage.local.get(e=>{chrome.storage.local.set({scrape_status:"Finished",scrapped_items_arr:[],total_scrapped_page:0,total_scrapped_count:0,current_processed_count:0,authUser:!1,userFreeTrialStarted:!1,userTrialIsStarted:!1,authName:"",userRegistered:!1,active_search_tab_id:0,is_expired:!1,username:"",key:"",token_id:"",activate_date:"",last_item_index:0,scrape_type:"Single",scrape_keywords_arr:[],scrape_limit_type:"All",scrape_limit:20,scrape_keywords_file_name:"",keyword_time_delay_min:5,keyword_time_delay_max:15,data_extract_time_delay_min:1,data_extract_time_delay_max:2,saved_api_base_url:consts.base_api_url,skip_duplicate_record_check:!1,skip_without_number_record_check:!1,product_launched:0,product_trial_started:0})}),myAppObj.saveInstallToServer(),chrome.tabs.create({url:"https://blog.scrappertool.com/how-to-use-g-map-data-scrapper-tool//#get-started"}),setTimeout(function(){chrome.storage.local.get(e=>{PopupCenter(1==e.authUser?chrome.runtime.getURL("html/index.html"):chrome.runtime.getURL("html/free-version.html"),"Business Scrapper Tool",1050,650),myAppObj.productLaunched()})},5e3)):"update"==e.reason&&myAppObj.saveXClientIdToServer()}),chrome.webRequest.onCompleted.addListener(t=>{chrome.storage.local.get(e=>{t&&t.tabId&&t.tabId&&parseInt(t.tabId)==parseInt(e.active_search_tab_id)&&t.url.includes("/search?tbm=map")&&-1==t.initiator.indexOf("chrome-extension://")&&fetch(t.url).then(e=>e.text()).then(e=>{chrome.tabs.sendMessage(t.tabId,{command:"injectDataToDOM",data:e})}).catch(e=>console.log("Error fetching data:",e))})},{urls:["<all_urls>"]});