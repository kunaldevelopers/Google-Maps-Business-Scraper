var e=[],t={uiSettings:{},load:function(){t.addEvents(),t.initSettings(),t.checkUserAuth()},initSettings:function(){chrome.storage.local.get(e=>{t.uiSettings=e,$("#user_email").val(t.uiSettings.username),$("#user_key").val(t.uiSettings.key)})},checkUserAuth:async function(){chrome.storage.local.get(e=>{""!=e.key&&""!=e.token_id&&t.authUserToServer({},"sender",async function(e){e&&1==e.success&&1==e.data&&(t.uiSettings.authUser=!0,t.uiSettings.userFreeTrialStarted=!1,chrome.storage.local.set({userFreeTrialStarted:t.uiSettings.userFreeTrialStarted,authUser:t.uiSettings.authUser},function(e){location.href="index.html"}))})})},addEvents:function(){$(document).on("click",".go-to-free-trial-btn",function(e){e.preventDefault(),chrome.storage.local.get(e=>{t.uiSettings=e,t.uiSettings.userFreeTrialStarted=!0,t.uiSettings.authUser=!0,chrome.storage.local.set({userFreeTrialStarted:t.uiSettings.userFreeTrialStarted,authUser:t.uiSettings.authUser},function(e){location.href="index.html"})})}),$(document).on("submit","#add-subscriber-form",function(e){var a,n;e.preventDefault(),(a=$(this)).find(".error-msg").html("").closest(".f-form-input-group").removeClass("has-error"),n=showLoading(),setTimeout(function(){$.ajax({type:"POST",dataType:"JSON",processData:!1,contentType:!1,url:consts.base_api_url+consts.save_user_api_url,data:new FormData(a[0]),success:function(e){loadingOut(n),1==e.success?(Swal({type:"success",title:"Activated!",html:e.message,dangerMode:!0,showCancelButton:!1,showConfirmButton:!1}),(async()=>{chrome.storage.local.get(n=>{t.uiSettings=n,t.uiSettings.authUser=!0,t.uiSettings.userFreeTrialStarted=!1,t.uiSettings.authName=a.find("#user_email").val(),t.uiSettings.key=a.find("#subscription_key").val(),t.uiSettings.username=a.find("#user_email").val(),t.uiSettings.activate_date=btoa((new Date).getTime()),t.uiSettings.token_id=e.token_id,chrome.storage.local.set({userFreeTrialStarted:t.uiSettings.userFreeTrialStarted,authName:t.uiSettings.authName,key:t.uiSettings.key,username:t.uiSettings.username,token_id:t.uiSettings.token_id,activate_date:t.uiSettings.activate_date,authUser:t.uiSettings.authUser}),setTimeout(function(){location.href="index.html"},5e3)})})()):0==e.success&&e&&null!=e.message&&Swal({type:"error",title:"Oops!...",text:e.message,dangerMode:!0,showCancelButton:!1,showConfirmButton:!1,timer:5e3})},error:function(e){loadingOut(n),Swal({type:"error",title:"Oops!...",text:"Something went wrong! Please try again later",dangerMode:!0,showCancelButton:!1,showConfirmButton:!1,timer:5e3})}})},1e3)})},authUserToServer:function(e,t,a){chrome.storage.local.get(e=>{var t,n,s=new Headers;s.append("x-key",e.key),s.append("x-csrf-token",e.token_id),s.append("x-product-id","1"),s.append("Content-Type","application/x-www-form-urlencoded"),(t=new URLSearchParams).append("email",e.authName),n={method:"POST",headers:s,body:t,redirect:"follow"},fetch(consts.v2_base_api_url+consts.auth_user_api_url,n).then(e=>e.json()).then(e=>a(e)).catch(e=>console.log("error",e))})}};function sendMessage(t,a){null!=a&&(e.push(a),t.callback="yes"),chrome.runtime.sendMessage(t,a)}function handleMessage(t,a){if(t.command,void 0!==t.data&&void 0!==t.callback&&"yes"==t.callback)e.pop()}window.addEventListener("load",function(){chrome.runtime.onMessage.addListener(handleMessage),t.load()});