var e=/.txt$/,t=new RegExp("^((http|https)://|(mailto:)|(//))[a-z0-9]","i"),s={uiSettings:{},scrape_keywords_arr:[],scrape_keywords_file_name:"",load:function(){s.addEvents(),s.setSettingsValues(),s.updateScrapeState(),s.checkUserAuth()},addEvents:function(){$(document).on("click",".close-popup",function(e){self.close()}),$(document).on("click",".sign-out-btn",function(e){e.preventDefault(),chrome.storage.local.get(e=>{s.uiSettings=e,s.uiSettings.authUser=!1,s.uiSettings.authName="",chrome.storage.local.set({authUser:s.uiSettings.authUser,authName:s.uiSettings.authName},function(e){location.href="login.html"})})}),$(document).on("click",".export-data-btn",function(e){e.preventDefault(),chrome.storage.local.get(e=>{var t,r,a,i,n;for(s.uiSettings=e,t=[],r=s.uiSettings.scrape_keywords_arr,a=0;a<r.length;a++)for(i=r[a].result_items_arr||[],n=0;n<i.length;n++)t.push(i[n]);sendMessage({command:"downloadCSV",data:t},function(e){})})}),$(document).on("click",".clear-data-btn",function(e){Swal.fire({type:"warning",title:"Are you sure you want to clear report data!",text:"",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Confirm"}).then(async t=>{t.value&&(e.preventDefault(),chrome.storage.local.get(e=>{s.uiSettings=e,s.uiSettings.last_item_index=0,s.uiSettings.current_processed_count=0,s.uiSettings.scrape_keywords_arr=[],chrome.storage.local.set({last_item_index:s.uiSettings.last_item_index,current_processed_count:s.uiSettings.current_processed_count,scrape_keywords_arr:s.uiSettings.scrape_keywords_arr}),location.reload()}))})}),$(document).on("submit","#start-search-form",function(t){var r,a,i,n,o,c,d,u,l,p;if(t.preventDefault(),$(this),!1,"Start Process"==(r=$(this).find('[type="submit"]')).text()){if(a="Multiple",i=$('[name="scrape_limit_type"]:checked').val(),n=$("#scrape_limit").val(),"Limit"==i&&(""==n||0==n||"0"==n))return showSwal("error","Oops!...","You need to enter a scrape limit",3e3),!1;if(o=5,c=10,d=1,u=2,"Multiple"==a)if(""==$("#keywords_file").val()){if(""==$("#keywords_input").val())return showSwal("error","Oops!...","You need to enter a keywords OR \n You need to select a txt file for keywords",3e3),!1;for(s.scrape_keywords_arr=[],l=$("#keywords_input").val().split(","),p=0;p<l.length;p++)l[p].trim()&&s.scrape_keywords_arr.push({keyword:l[p].trim(),status:"Pending"})}else if(1!=e.test(String($("#keywords_file").val()).toLowerCase()))return showSwal("error","Oops!...","You need to select only txt file (Ex : sample-keywords.txt)",3e3),!1;if(1==!(s.scrape_keywords_arr.length>0))return showSwal("error","Oops!...","keywords not found",3e3),!1;r.text("Stop & Download CSV"),r.removeClass("start-proccess-btn"),r.addClass("stop-proccess-btn"),$("#currentProcessedCount").text(0),chrome.storage.local.get(e=>{var t,r,a,l;for(s.uiSettings=e,r=(t=s.scrape_keywords_arr)[0].keyword,t[0].status="Inprogress",s.uiSettings.scrape_keywords_file_name=s.scrape_keywords_file_name,s.uiSettings.scrape_limit=parseInt(n),s.uiSettings.keyword_time_delay_min=parseInt(o),s.uiSettings.keyword_time_delay_max=parseInt(c),s.uiSettings.data_extract_time_delay_min=parseInt(d),s.uiSettings.data_extract_time_delay_max=parseInt(u),s.uiSettings.scrape_limit_type=i,a=s.uiSettings.scrape_keywords_arr,l=0;l<a.length;l++)a[l].status="Finished";for(l=0;l<t.length;l++)a.push(t[l]);s.uiSettings.scrape_keywords_arr=a,s.uiSettings.scrape_type="Multiple",s.uiSettings.last_item_index=0,s.uiSettings.current_processed_count=0,s.uiSettings.scrape_status="Inprogress",chrome.storage.local.set({scrape_keywords_arr:s.uiSettings.scrape_keywords_arr,scrape_type:s.uiSettings.scrape_type,last_item_index:s.uiSettings.last_item_index,current_processed_count:s.uiSettings.current_processed_count,scrape_status:s.uiSettings.scrape_status,scrape_keywords_file_name:s.uiSettings.scrape_keywords_file_name,scrape_limit:s.uiSettings.scrape_limit,keyword_time_delay_min:s.uiSettings.keyword_time_delay_min,keyword_time_delay_max:s.uiSettings.keyword_time_delay_max,data_extract_time_delay_min:s.uiSettings.data_extract_time_delay_min,data_extract_time_delay_max:s.uiSettings.data_extract_time_delay_max,scrape_limit_type:s.uiSettings.scrape_limit_type}),sendMessage({command:"startSearchProcess",data:{Keywords_input:r}},function(e){})})}else r.text("Start Process"),r.removeClass("stop-proccess-btn"),r.addClass("start-proccess-btn"),sendMessage({command:"stopAutoBotProcess",reason:"manual_stop"},function(e){})}),$(document).on("click","#resume-last-Scrape-btn",function(e){e.preventDefault();var t=$("#start-search-form").find('[type="submit"]');chrome.storage.local.get(e=>{var r,a,i,n;for(s.uiSettings=e,r="",a=s.uiSettings.scrape_keywords_arr,i=0;i<a.length;i++)if("Pending"==a[i].status||"Inprogress"==a[i].status){a[i].status="Inprogress",r=a[i].keyword;break}""!=r?(t.text("Stop & Download CSV"),t.removeClass("start-proccess-btn"),t.addClass("stop-proccess-btn"),$("#currentProcessedCount").text(0),$("#resume-last-Scrape-btn").hide(),n=r,s.uiSettings.scrape_keywords_arr=a,s.uiSettings.scrape_type="Multiple",s.uiSettings.last_item_index=0,s.uiSettings.current_processed_count=0,s.uiSettings.scrape_status="Inprogress",chrome.storage.local.set({scrape_keywords_arr:s.uiSettings.scrape_keywords_arr,scrape_type:s.uiSettings.scrape_type,last_item_index:s.uiSettings.last_item_index,current_processed_count:s.uiSettings.current_processed_count,scrape_status:s.uiSettings.scrape_status}),sendMessage({command:"startSearchProcess",data:{Keywords_input:n}},function(e){})):showSwal("error","Oops!...","Not found last scrpae process!",3e3)})}),$(document).on("change keyup input","#skip_duplicate_record_check",function(e){var t=$(this).is(":checked");chrome.storage.local.get(e=>{s.uiSettings=e,s.uiSettings.skip_duplicate_record_check=t,chrome.storage.local.set({skip_duplicate_record_check:s.uiSettings.skip_duplicate_record_check})})}),$(document).on("change keyup input","#skip_without_number_record_check",function(e){var t=$(this).is(":checked");chrome.storage.local.get(e=>{s.uiSettings=e,s.uiSettings.skip_without_number_record_check=t,chrome.storage.local.set({skip_without_number_record_check:s.uiSettings.skip_without_number_record_check})})}),$(document).on("change","#keywords_file",function(e){s.uploadFile(e)}),$(document).on("change",'[name="scrape_limit_type"]',function(e){"Limit"==$(this).val()?$("#scrape_limit_section").show():$("#scrape_limit_section").hide()}),$(document).on("click",".download-keywords-name-btn",function(e){var t,s;e.preventDefault(),t="data:text/csv;charset=utf-8,"+escape("school in ahmedabad\ngym in delhi\nhospital in mumbai\ncomputer shops near me\nChemists in delhi"),(s=document.createElement("a")).href=t,s.style="visibility:hidden",s.download="sample-keywords.txt",document.body.appendChild(s),s.click()})},browserSupportFileUpload:function(){var e=!1;return window.File&&window.FileReader&&window.FileList&&window.Blob&&(e=!0),e},uploadFile:function(e){var t,r;s.browserSupportFileUpload()?(null,t=e.target.files[0],(r=new FileReader).onload=function(e){try{var r=e.target.result;r&&void 0!==r&&null!=r&&null!=r&&(s.parseDataFromFile(r),s.scrape_keywords_file_name=t.name)}catch(a){}},r.readAsText(t,"ISO-8859-1"),r.onerror=function(){$("#error_msg").text("Unable to read "+t.name),$("#error_msg").show()}):($("#error_msg").text("The File APIs are not fully supported in this browser!"),$("#error_msg").show())},parseDataFromFile:function(e){var t,r;for(s.scrape_keywords_arr=[],t=e.split("\n"),r=0;r<t.length;r++)t[r].trim()&&s.scrape_keywords_arr.push({keyword:t[r].trim(),status:"Pending"})},authUserToServer:function(e,t,r){chrome.storage.local.get(e=>{var t,a,i=new Headers;i.append("x-key",e.key),i.append("x-csrf-token",e.token_id),i.append("x-product-id","1"),i.append("Content-Type","application/x-www-form-urlencoded"),(t=new URLSearchParams).append("email",e.authName),a={method:"POST",headers:i,body:t,redirect:"follow"},fetch(consts.v2_base_api_url+consts.auth_user_api_url,a).then(e=>e.json()).then(e=>r(e)).catch(e=>console.log("error",e)),s.setSettingsValues(),s.updateScrapeState()})},checkUserAuth:function(){chrome.storage.local.get(e=>{var t;s.uiSettings=e,1!=e.authUser?location.href="login.html":(t=e.authName,$("#logged-name").text(t)),""!=e.key&&""!=e.token_id&&s.authUserToServer({},"sender",function(e){e&&1==e.success&&(1==e.data?(s.setSettingsValues(),s.updateScrapeState()):chrome.storage.local.get(e=>{s.uiSettings=e,s.uiSettings.userFreeTrialStarted=!0,chrome.storage.local.set({userFreeTrialStarted:s.uiSettings.userFreeTrialStarted})}))})})},setSettingsValues:function(){chrome.storage.local.get(e=>{var t,r,a,i,n,o;if(s.uiSettings=e,t=s.uiSettings.scrape_status,r=$("#start-search-form").find('[type="submit"]'),"Finished"==t?(r.text("Start Process"),r.removeClass("stop-proccess-btn"),r.addClass("start-proccess-btn")):"Inprogress"==t?(r.text("Stop & Download CSV"),r.removeClass("start-proccess-btn"),r.addClass("stop-proccess-btn")):(r.text("Start Process"),r.removeClass("stop-proccess-btn"),r.addClass("start-proccess-btn")),"Finished"==t){for(a=s.uiSettings.scrape_keywords_arr,i="",n=0;n<a.length;n++)if("Pending"==a[n].status||"Inprogress"==a[n].status){i=a[n].keyword;break}""!=i?$("#resume-last-Scrape-btn").show():$("#resume-last-Scrape-btn").hide()}o=s.uiSettings.saved_api_base_url||consts.base_api_url,$("#saved_api_base_url").val(o)})},browserSupportFileUpload:function(){var e=!1;return window.File&&window.FileReader&&window.FileList&&window.Blob&&(e=!0),e},updateScrapeState:function(){chrome.storage.local.get(e=>{var t,r,a,i,n;s.uiSettings=e,t=s.uiSettings.total_scrapped_count,r=s.uiSettings.current_processed_count,$("#currentProcessedCount").text(r),$("#totalScrappedItems").text(t),a=s.uiSettings.skip_duplicate_record_check||!1,i=s.uiSettings.skip_without_number_record_check||!1,$("#skip_duplicate_record_check").prop("checked",a),$("#skip_without_number_record_check").prop("checked",i),s.setSettingsValues(),s.showScrapeItemsList(),chrome.storage.local.get(e=>{var t,r;s.uiSettings=e,t=s.uiSettings.userFreeTrialStarted,r=s.uiSettings.current_processed_count,1==t&&r>=10&&s.showFreeUserWarning()}),n=s.uiSettings.userFreeTrialStarted,s.uiSettings.authUser,1==n?($(".logged-user-info").hide(),$(".free-user-info").show()):($(".free-user-info").hide(),$(".logged-user-info").show())})},showFreeUserWarning:function(){showSwal("warning","Upgrade plan",'You Need to upgrade your plan for use this feature. </a>. <br> Click here to <a href="login.html"> Upgrade </a> your plan. <b>Note : </b> In trial version per query you can scrap up to 10 data only then after process stop automatically.',3e3)},showScrapeItemsList:function(){chrome.storage.local.get(e=>{var t,r,a,i,n,o,c,d;for(s.uiSettings=e,t=s.uiSettings.scrape_keywords_arr,r=[],a=0;a<t.length;a++)for(i=t[a].result_items_arr||[],n=0;n<i.length;n++)r.push(i[n]);for(o=r,c="",c="",d=0;d<o.length;d++)c+='<tr><td><div style="width: 45px;">'+(d+1)+' </div> </td><td><div style="width: 80px;">'+o[d].category+' </div> </td><td><div style="width: 130px;">'+o[d].business_name+' </div> </td><td><div style="width: 150px;">'+o[d].full_dddress+' </div> </td><td><div style="width: 120px;">'+(""!=o[d].phone_number?'<a href="tel:'+o[d].phone_number+'"> <i class="fa fa-phone"></i> '+o[d].phone_number+"</a>":"")+' </div> </td><td><div style="width: 300px;">'+(""!=o[d].email?'<a href="mailto:'+o[d].email+'"> <i class="fa fa-envelope"></i> '+o[d].email+"</a>":"")+' </div> </td><td><div style="width: 250px;">'+(""!=o[d].website?'<a target="_blank" href="'+(null!=o[d].website&&""!=o[d].website&&"#"!=o[d].website?o[d].website:"#")+'">'+(null!=o[d].website&&""!=o[d].website&&"#"!=o[d].website?'<i class="fa fa-link"></i>'+o[d].website:"")+"</a>":"")+' </div> </td><td><div style="width: 80px;">'+o[d].rating_score+' </div> </td><td><div style="width: 80px;">'+o[d].reviews_count+" </div> </td></tr>";"Finished"==s.uiSettings.scrape_status&&o.length>0||0==o.length&&(c+='<tr><td class="text-center text-danger" colspan="13"> No data found! </td></tr>'),$("#tbl_items_list").html(c)})}};function sendMessage(e,t){null!=t&&(e.callback="yes"),chrome.runtime.sendMessage(e,t)}function sendMessageActiveTab(e,t){chrome.tabs.query({active:!0,currentWindow:!0},function(s){chrome.tabs.sendMessage(s[0].id,e,t)})}function handleMessage(e,t){switch(e.command){case"rec_getSettings":s.uiSettings=e.data.uiSettings;break;case"updateScrapeState":s.updateScrapeState()}void 0!==e.data&&void 0!==e.data.callback&&"yes"==e.data.callback&&(callback(),callback=null)}$(document).ready(function(){chrome.runtime.onMessage.addListener(handleMessage)}),s.load();